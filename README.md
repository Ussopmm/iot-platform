# **IOT Platform**

Что бы подробнее ознакомиться с архитектурой системы рекомендуется рассмотреть C4 UML диаграммы.

Для просмотра перейдите в директорию [diagrams](./diagrams/).

**context.puml** описывает общий контекст системы. Показывает систему целиком и взаимодействия данной системы с
внешними пользователями и системами

[Контекст системы (context.puml)](./diagrams/context.puml)

**containers.puml** описывает внутреннее устройство системы, сервисы, базы данных, брокеры и т.д. и их
взаимодействие друг с другом

[Контейнеры системы (containers.puml)](./diagrams/containers.puml)

**ecs_component.puml** - описывает внутреннее устройство сервиса Event Collector Service

[Компоненты системы (ecs_component.puml)](./diagrams/ecs-diagrams/ecs_component.puml)

**processing_sequence.puml** - диаграмма последовательности обработки события от момента получения события
до момента записи в базу данных

[Sequence diagram (processing_sequence.puml)](./diagrams/ecs-diagrams/processing_sequence.puml)

**dcs_component.puml** - описывает внутреннее устройство сервиса Device Collector Service

[Компоненты системы (dcs_component.puml)](./diagrams/dcs-diagrams/dcs_component.puml)

**dcs_sequence_diagram.puml** - диаграмма последовательности обработки данных устройства от момента получения данных
до момента записи в базу данных с учетом возможных ошибок

[Sequence diagram (dcs_sequence_diagram.puml)](./diagrams/dcs-diagrams/dcs_sequence_diagram.puml)

# Инструкция по запуску системы

## Запуск системы

1. Перейдите в папку **infrastructure**:
```
cd infrastructure
```
2. Запустите контейнеры:
```
docker-compose up -d --build
```
Или через Makefile:
```
make up
```
3. Проверьте, что все контейнеры работают и имеют статус healthy:
```
docker ps | make ps
```
4. Перейдите по пути http://localhost:8080 что бы увидеть интерфейс кейклока,
   http://localhost:3000, чтобы увидеть интерфейс Grafana. И если, все успешно открывается,
значит вы все правильно запустили
5. Чтобы остановить контейнеры:
```
docker-compose down | make down
``` 


## Описание сервисов

### device-collector-service
Сервис предназначен для обработки событий из соответствующего топика Kafka (ассинхронно, использовался Spring Reactive [Mono/Flux]) 
и записи этих событий в шардированную базу данных, которая контролируется Apache ShardingSphere. Чтобы избежать дублирования 
и поддерживать идемпотентность данных, используется upsert операция. При возникновении ошибок в процессе сохранения данных, был
реализован exponential retry with backoff с ограничением по количеству попыток. Если все попытки исчерпаны, событие отправляется в топик ошибок Kafka для дальнейшего анализа и обработки.

### event-collector-service
Сервис принимает события из внешнего источника, который направляет все данные в соответствующий топик Кафки. 
Далее сервис обрабатывает события, сохраняет в базу данных Cassandra и публикует событие, которое содержит данные
об устройстве в отдельный топик Кафки для дальнейшей обработки другими сервисами.

### avro-schemas 
Данный модуль предназначен для публикации Avro schemas в Nexus репозиторий.